<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üå¨Ô∏è AIR Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<style>
/* Reset & base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body, html {
  height: 100%;
  font-family: "Inter", sans-serif;
  background: linear-gradient(135deg, #1e40af, #60a5fa);
  color: #1f2937;
  overflow: hidden;
  transition: background 0.3s ease;
}

body.dark-mode {
  background: linear-gradient(135deg, #1f2937, #4b5563);
  color: #e5e7eb;
}

/* Dashboard layout */
.dashboard-container {
  display: flex;
  height: 100vh;
  background: rgba(255, 255, 255, 0.97);
  border-radius: 20px;
  margin: 20px;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(8px);
}

/* Upgrade banner */
.upgrade-banner {
  background: linear-gradient(90deg, #f59e0b, #f97316);
  color: #ffffff;
  padding: 16px;
  text-align: center;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 10px;
  margin: 16px;
  display: none;
}
.upgrade-banner a {
  color: #ffffff;
  text-decoration: underline;
  font-weight: 700;
}
.upgrade-banner a:hover {
  color: #e5e7eb;
}

/* Sidebar */
.sidebar {
  width: 280px;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  border-right: 1px solid #d1d5db;
  background: #ffffff;
  border-radius: 20px 0 0 20px;
}
.dark-mode .sidebar {
  background: #1f2937;
  border-right-color: #4b5563;
}
.sidebar h2 {
  font-size: 1.5rem;
  color: #1e40af;
  font-weight: 600;
}
.dark-mode .sidebar h2 {
  color: #60a5fa;
}
.sidebar .metric {
  background: #f3f4f6;
  padding: 12px 16px;
  border-radius: 10px;
  font-weight: 500;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: transform 0.3s ease, background 0.3s ease;
}
.dark-mode .sidebar .metric {
  background: #374151;
  color: #e5e7eb;
}
.sidebar .metric:hover {
  transform: translateX(5px);
  background: #e5e7eb;
}
.dark-mode .sidebar .metric:hover {
  background: #4b5563;
}
.sidebar .metric.restricted {
  filter: blur(3px);
  pointer-events: none;
  position: relative;
}
.sidebar .metric.restricted::after {
  content: "Upgrade to Pro";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.7);
  color: #ffffff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
}

/* Main content */
.main-content {
  flex: 1;
  padding: 24px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.header h1 {
  font-size: 1.8rem;
  color: #1e40af;
  font-weight: 600;
}
.dark-mode .header h1 {
  color: #60a5fa;
}
.header .controls {
  display: flex;
  gap: 12px;
}
.header button {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}
#themeToggle {
  background: #3b82f6;
  color: #ffffff;
}
#themeToggle:hover {
  background: #2563eb;
}
#logoutBtn, #activityBtn {
  background: #ef4444;
  color: #ffffff;
}
#logoutBtn:hover, #activityBtn:hover {
  background: #dc2626;
}
#activityBtn.restricted {
  opacity: 0.5;
  pointer-events: none;
}
.notification-bell {
  position: relative;
  background: transparent;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  color: #1e40af;
}
.dark-mode .notification-bell {
  color: #60a5fa;
}
.notification-bell .badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ef4444;
  color: #ffffff;
  border-radius: 50%;
  padding: 4px 8px;
  font-size: 0.7rem;
}

/* Chart */
.chart-container {
  background: #ffffff;
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  position: relative;
}
.dark-mode .chart-container {
  background: #1f2937;
}
.chart-container.restricted {
  filter: blur(3px);
  pointer-events: none;
}
.chart-container.restricted::after {
  content: "Upgrade to Pro for Usage Charts";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.7);
  color: #ffffff;
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 1rem;
}

/* Logs */
.logs-section h2 {
  font-size: 1.4rem;
  color: #1e40af;
  margin-bottom: 12px;
}
.dark-mode .logs-section h2 {
  color: #60a5fa;
}
.log-entry {
  background: #f3f4f6;
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 10px;
  font-size: 0.9rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s ease;
}
.dark-mode .log-entry {
  background: #374151;
  color: #e5e7eb;
}
.log-entry.info { border-left: 4px solid #3b82f6; }
.log-entry.warning { border-left: 4px solid #f59e0b; }
.log-entry.critical { border-left: 4px solid #ef4444; }
.log-entry:hover {
  transform: translateX(3px);
}

/* AI Chat */
.ai-chat {
  background: #ffffff;
  border-radius: 14px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.dark-mode .ai-chat {
  background: #1f2937;
}
.ai-chat input[type="text"] {
  padding: 12px 20px;
  border-radius: 50px;
  border: 1px solid #d1d5db;
  background: #f3f4f6;
  font-size: 0.95rem;
  outline: none;
  transition: all 0.3s ease;
}
.dark-mode .ai-chat input[type="text"] {
  background: #374151;
  border-color: #4b5563;
  color: #e5e7eb;
}
.ai-chat input[type="text"]::placeholder {
  color: #6b7280;
}
.ai-chat input[type="text"]:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 8px rgba(59, 130, 246, 0.25);
  background: #ffffff;
}
.dark-mode .ai-chat input[type="text"]:focus {
  background: #4b5563;
}
.ai-chat button {
  align-self: flex-end;
  background: linear-gradient(90deg, #3b82f6, #60a5fa);
  color: #ffffff;
  font-weight: 600;
  padding: 10px 20px;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.ai-chat button:hover {
  background: linear-gradient(90deg, #2563eb, #3b82f6);
}
.ai-chat button.restricted {
  opacity: 0.5;
  pointer-events: none;
}
#aiResponse {
  background: #f3f4f6;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 0.9rem;
  max-height: 250px;
  overflow-y: auto;
}
.dark-mode #aiResponse {
  background: #374151;
  color: #e5e7eb;
}

/* Scrollbars */
::-webkit-scrollbar {
  width: 6px;
}
::-webkit-scrollbar-track {
  background: #f3f4f6;
}
.dark-mode ::-webkit-scrollbar-track {
  background: #1f2937;
}
::-webkit-scrollbar-thumb {
  background: #3b82f6;
  border-radius: 3px;
}
.dark-mode ::-webkit-scrollbar-thumb {
  background: #60a5fa;
}

/* Responsive adjustments */
@media (max-width: 1024px) {
  .dashboard-container {
    flex-direction: column;
    margin: 10px;
  }
  .sidebar {
    width: 100%;
    border-right: none;
    border-bottom: 1px solid #d1d5db;
    border-radius: 20px 20px 0 0;
  }
  .dark-mode .sidebar {
    border-bottom-color: #4b5563;
  }
}
@media (max-width: 768px) {
  .dashboard-container {
    margin: 8px;
  }
  .sidebar, .main-content {
    padding: 16px;
  }
  .header h1 {
    font-size: 1.5rem;
  }
  .upgrade-banner {
    font-size: 0.9rem;
    padding: 12px;
  }
}
</style>
</head>
<body>
<div class="upgrade-banner" id="upgradeBanner">
  Unlock all features with Pro or Admin plans! <a href="/upgrade.html">Upgrade Now</a>
</div>

<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>AIR Metrics</h2>
    <div class="metric"><span>AI Mode</span><span id="aiMode">--</span></div>
    <div class="metric"><span>CPU Usage</span><span id="cpuUsage">--</span></div>
    <div class="metric restricted" id="ramMetric"><span>RAM Usage</span><span id="ramUsage">--</span></div>
    <div class="metric restricted" id="mongoMetric"><span>Mongo Usage</span><span id="mongoUsage">--</span></div>
    <div class="metric restricted" id="backupMetric"><span>Last Backup</span><span id="lastBackup">--</span></div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>AIR Dashboard</h1>
      <div class="controls">
        <button class="notification-bell" id="notificationBell">
          üîî <span class="badge" id="notificationCount" style="display: none;">0</span>
        </button>
        <button id="themeToggle">Dark Mode</button>
        <button id="activityBtn" class="restricted">View Activity</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="chart-container restricted" id="chartContainer">
      <canvas id="usageChart"></canvas>
    </div>

    <div class="logs-section">
      <h2>Last <span id="logCount">5</span> Logs</h2>
      <div id="logsContainer"></div>
    </div>

    <div class="ai-chat">
      <h2>AIR Chat</h2>
      <input type="text" id="aiInput" placeholder="Ask AIR something...">
      <button id="aiSend" class="restricted">Send</button>
      <div id="aiResponse" style="white-space: pre-wrap;"></div>
    </div>
  </div>
</div>

<script>
const aiModeEl = document.getElementById("aiMode");
const cpuEl = document.getElementById("cpuUsage");
const ramEl = document.getElementById("ramUsage");
const mongoEl = document.getElementById("mongoUsage");
const lastBackupEl = document.getElementById("lastBackup");
const logsContainer = document.getElementById("logsContainer");
const aiInput = document.getElementById("aiInput");
const aiSend = document.getElementById("aiSend");
const themeToggle = document.getElementById("themeToggle");
const logoutBtn = document.getElementById("logoutBtn");
const activityBtn = document.getElementById("activityBtn");
const notificationBell = document.getElementById("notificationBell");
const notificationCount = document.getElementById("notificationCount");
const upgradeBanner = document.getElementById("upgradeBanner");
const chartContainer = document.getElementById("chartContainer");
const ramMetric = document.getElementById("ramMetric");
const mongoMetric = document.getElementById("mongoMetric");
const backupMetric = document.getElementById("backupMetric");
const logCount = document.getElementById("logCount");

// Check user plan
const userPlan = localStorage.getItem("air_plan") || "free";
if (userPlan === "free") {
  upgradeBanner.style.display = "block";
} else {
  ramMetric.classList.remove("restricted");
  mongoMetric.classList.remove("restricted");
  backupMetric.classList.remove("restricted");
  chartContainer.classList.remove("restricted");
  aiSend.classList.remove("restricted");
  if (userPlan === "admin") {
    activityBtn.classList.remove("restricted");
  }
}

// Chart setup
const ctx = document.getElementById("usageChart").getContext("2d");
const usageChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      {
        label: "CPU Usage (%)",
        data: [],
        borderColor: "#3b82f6",
        backgroundColor: "rgba(59, 130, 246, 0.2)",
        fill: true,
      },
      {
        label: "RAM Usage (%)",
        data: [],
        borderColor: "#f59e0b",
        backgroundColor: "rgba(245, 158, 11, 0.2)",
        fill: true,
      },
    ],
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: { beginAtZero: true, max: 100 },
      x: { display: false },
    },
  },
});

// Store usage history
const usageHistory = { cpu: [], ram: [] };
const maxDataPoints = 10;

// Fetch metrics + logs
async function fetchStatus() {
  try {
    const status = await fetch("/api/status").then(r => r.json());
    const logs = await fetch("/api/dashboard").then(r => r.json());

    aiModeEl.textContent = status.aiMode;
    cpuEl.textContent = status.cpu + "%";
    ramEl.textContent = status.ram + "%";
    mongoEl.textContent = status.mongoUsage + "%";
    lastBackupEl.textContent = status.lastBackup || "N/A";

    // Update chart
    if (userPlan !== "free") {
      usageHistory.cpu.push(status.cpu);
      usageHistory.ram.push(status.ram);
      if (usageHistory.cpu.length > maxDataPoints) {
        usageHistory.cpu.shift();
        usageHistory.ram.shift();
      }
      usageChart.data.labels = Array(usageHistory.cpu.length).fill("");
      usageChart.data.datasets[0].data = usageHistory.cpu;
      usageChart.data.datasets[1].data = usageHistory.ram;
      usageChart.update();
    }

    // Update logs
    logsContainer.innerHTML = "";
    const maxLogs = userPlan === "free" ? 3 : 5;
    logCount.textContent = maxLogs;
    const criticalLogs = logs.filter(log => log.severity === "critical").length;
    notificationCount.textContent = criticalLogs;
    notificationCount.style.display = criticalLogs > 0 ? "inline" : "none";
    logs.slice(-maxLogs).reverse().forEach(log => {
      const div = document.createElement("div");
      div.className = "log-entry " + log.severity;
      div.textContent = `[${log.severity.toUpperCase()}] ${log.message} (${new Date(log.timestamp).toLocaleTimeString()})`;
      logsContainer.appendChild(div);
    });
  } catch (err) { console.error(err); }
}

// Send AI chat request
aiSend.addEventListener("click", async () => {
  const msg = aiInput.value.trim();
  if (!msg) return;
  aiResponse.textContent = "AIR is thinking...";
  try {
    const endpoint = userPlan === "pro" || userPlan === "admin" ? "/api/ai-pro" : "/api/ai";
    const res = await fetch(endpoint, {
      method: userPlan === "pro" || userPlan === "admin" ? "POST" : "GET",
      headers: userPlan === "pro" || userPlan === "admin" ? { "Content-Type": "application/json", "Authorization": `Bearer ${localStorage.getItem("air_token")}` } : {},
      body: userPlan === "pro" || userPlan === "admin" ? JSON.stringify({ msg }) : undefined,
      ...(userPlan === "free" ? { credentials: "omit" } : {})
    });
    const data = await res.json();
    aiResponse.textContent = data.response || "Error contacting AIR.";
  } catch (err) {
    aiResponse.textContent = "Error contacting AIR.";
  }
  aiInput.value = "";
});

// View activity logs (admin only)
activityBtn.addEventListener("click", async () => {
  if (userPlan !== "admin") return;
  try {
    const res = await fetch("/api/activity", {
      headers: { "Authorization": `Bearer ${localStorage.getItem("air_token")}`, "x-api-key": "air-api-key-secure" }
    });
    const activities = await res.json();
    aiResponse.textContent = activities.map(a => `[${new Date(a.timestamp).toLocaleString()}] ${a.userEmail}: ${a.action}`).join("\n");
  } catch (err) {
    aiResponse.textContent = "Error fetching activity logs.";
  }
});

// Theme toggle
themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  themeToggle.textContent = document.body.classList.contains("dark-mode") ? "Light Mode" : "Dark Mode";
});

// Logout
logoutBtn.addEventListener("click", () => {
  localStorage.removeItem("air_token");
  localStorage.removeItem("air_username");
  localStorage.removeItem("air_plan");
  window.location.href = "/login.html";
});

// Refresh metrics every 10 seconds
fetchStatus();
setInterval(fetchStatus, 10000);
</script>
</body>
</html>



